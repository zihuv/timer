name: Build macOS App

on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例如: 1.0.0)'
        required: true
        default: '1.0.0'
      configuration:
        description: '构建配置'
        required: true
        default: 'Release'
        type: choice
        options:
          - Debug
          - Release
      create_release:
        description: '创建 GitHub Release'
        required: true
        default: true
        type: boolean
      release_notes:
        description: 'Release 说明'
        required: false
        default: '发布新版本'
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build Timer App
    runs-on: macos-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 显示 Xcode 版本
        run: xcodebuild -version

      - name: 构建项目
        run: |
          cd timer
          xcodebuild -project timer.xcodeproj \
            -scheme countdown \
            -configuration ${{ inputs.configuration }} \
            build

      - name: 准备构建产物
        run: |
          mkdir -p artifacts
          if [ "${{ inputs.configuration }}" = "Release" ]; then
            cp -R ~/Library/Developer/Xcode/DerivedData/countdown-*/Build/Products/Release/countdown.app artifacts/
          else
            cp -R ~/Library/Developer/Xcode/DerivedData/countdown-*/Build/Products/Debug/countdown.app artifacts/
          fi

      - name: 打包成 ZIP
        run: |
          cd artifacts
          zip -r timer-${{ inputs.version }}-${{ inputs.configuration }}.zip timer.app
          cd ..

      - name: 上传构建产物到 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: timer-macos-${{ inputs.configuration }}
          path: artifacts/timer-*.zip
          retention-days: 30

      - name: 创建 GitHub Release 并上传
        if: ${{ inputs.create_release == true && inputs.configuration == 'Release' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: Timer v${{ inputs.version }}
          body: ${{ inputs.release_notes }}
          files: artifacts/timer-*.zip
          draft: false
          prerelease: ${{ inputs.configuration == 'Debug' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
